<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Creating data pipelines with Python</title>
  <meta name="description" content="While continuing exploring python’s simplicity we came across with generators, python’s way to process data “on the fly”.">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/2018/02/02/data-pipelines-python.html">
  
  
  <link rel="alternate" type="application/rss+xml" title="Memo García" href="http://localhost:4000/feed.xml">

  <link rel="icon" type="image/x-icon" href="/favicon.ico">
<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">

  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="Creating data pipelines with Python">
  <meta name="twitter:description" content="While continuing exploring python’s simplicity we came across with generators, python’s way to process data “on the fly”.">
  
  

  <script type="text/javascript">
  WebFontConfig = {
    google: { families: [ 'Bitter:400,700,400italic:latin' ] }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  
  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-113718590-1', 'auto');
    ga('send', 'pageview');
  </script>

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Memo García</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="https://github.com/memogarcia">GitHub</a>
      
        
        <a class="page-link" href="https://gist.github.com/memogarcia">Gists</a>
      
        
        <a class="page-link" href="https://drive.google.com/file/d/1nNesMdP9fkTkA_TdudnO0aVKv7yyjIVZ/view?usp=sharing">CV</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">Creating data pipelines with Python</h1>
    
    <p class="post-meta"><time datetime="2018-02-02T14:22:38+01:00" itemprop="datePublished">Feb 2, 2018</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>While continuing exploring python’s simplicity we came across with <code class="highlighter-rouge">generators</code>, python’s way to process data “on the fly”.</p>

<p>The conventional way of processing data in python is by using <code class="highlighter-rouge">iterators</code>, python objects that can be iterated, a list, a string, etc. The downsize of iterators is that it has to hold its elements in memory and thus, is restricted by the physical amount of memory in your system.</p>

<p>This is an iterator example that returns a list of files.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>


<span class="k">def</span> <span class="nf">list_files</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="s">"."</span><span class="p">,</span> <span class="n">topdown</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">files</span>
</code></pre></div></div>

<p>Notice 2 behaviors here: To consume the list of files you have to wait until the functions returns and the list of files is being held in memory.</p>

<p>This is where generators come handy, it allows python to work with data in chunks of data rather than with the whole and gives you the ability to develop data pipelines where your data can be processed as is being read.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>


<span class="k">def</span> <span class="nf">list_files</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="s">"."</span><span class="p">,</span> <span class="n">topdown</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">consume_files</span><span class="p">():</span>
    <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">list_files</span><span class="p">(</span><span class="s">'/tmp'</span><span class="p">):</span>
        <span class="c"># do something with a single element</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
</code></pre></div></div>

<p>With this example, we can start to consume data as soon as is available with one restriction, once the data is consumed python will <code class="highlighter-rouge">forget</code> about it. while consuming less memory it might be an issue if some of the data is not processed correctly.</p>

<p>Here is a more complex example of data processing using generators where we find for a keyword is a list of files.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">bz2</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>


<span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="n">filepat</span><span class="p">,</span> <span class="n">top</span><span class="p">):</span>
    <span class="s">'''
    Find all files in a directory tree that match a shell wildcard pattern
    '''</span>
    <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">dirlist</span><span class="p">,</span> <span class="n">filelist</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">top</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">fnmatch</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">filelist</span><span class="p">,</span> <span class="n">filepat</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">opener</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
    <span class="s">'''
    Open a sequence of files one at a time producing a file object.
    The file is closed immediately when proceeding to the next iteration.
    '''</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">'.gz'</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">'rt'</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">'.bz2'</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">'rt'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">'rt'</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">f</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">concatenate</span><span class="p">(</span><span class="n">iterators</span><span class="p">):</span>
    <span class="s">'''
    Chain a sequence of iterators together into a single sequence.
    '''</span>
    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">iterators</span><span class="p">:</span>
        <span class="k">yield</span> <span class="k">from</span> <span class="n">it</span>


<span class="k">def</span> <span class="nf">grep</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
    <span class="s">'''
    Look for a regex pattern in a sequence of lines
    '''</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pat</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">line</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">lognames</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="s">'*.log*'</span><span class="p">,</span> <span class="s">'/var/log/'</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">opener</span><span class="p">(</span><span class="n">lognames</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="n">pylines</span> <span class="o">=</span> <span class="n">grep</span><span class="p">(</span><span class="s">'(?i)python'</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">pylines</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</code></pre></div></div>

  </div>

  
    <div class="post-comments" itemprop="comment">
      <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'http://localhost:4000/2018/02/02/data-pipelines-python.html';
      this.page.identifier = 'http://localhost:4000/2018/02/02/data-pipelines-python.html';
    };
    (function() {
      var d = document, s = d.createElement('script');
      s.src = 'https://memogarcia.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

    </div>
  

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

<a href="mailto:root@memogarcia.mx">root@memogarcia.mx</a> | <a href="http://localhost:4000/feed.xml">RSS</a>

    </p>

  </div>

</footer>


  </body>

</html>
