<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Becoming a certificate authority for SSL</title>
  <meta name="description" content="A Certificate Authority or CA is an entity that signs digital certificates. These digital certificates are used to validate the connection while using secure mechanisms.">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/2018/02/07/becoming-ca.html">
  
  
  <link rel="alternate" type="application/rss+xml" title="Memo García" href="http://localhost:4000/feed.xml">

  <link rel="icon" type="image/x-icon" href="/favicon.ico">
<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">

  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="Becoming a certificate authority for SSL">
  <meta name="twitter:description" content="A Certificate Authority or CA is an entity that signs digital certificates. These digital certificates are used to validate the connection while using secure mechanisms.">
  
  

  <script type="text/javascript">
  WebFontConfig = {
    google: { families: [ 'Bitter:400,700,400italic:latin' ] }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Memo García</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="https://github.com/memogarcia">GitHub</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">Becoming a certificate authority for SSL</h1>
    
    <p class="post-meta"><time datetime="2018-02-07T12:22:38+01:00" itemprop="datePublished">Feb 7, 2018</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>A Certificate Authority or CA is an entity that signs digital certificates.
These digital certificates are used to validate the connection while using secure mechanisms.</p>

<h2 id="root-ca">root CA</h2>

<p>We will use a root CA to create intermediate CA’s which are trusted to sign certificates on its behalf.</p>

<p>First, prepare the environment.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /root/ca <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /root/ca
mkdir certs crl newcerts private
chmod 700 private
touch index.txt
<span class="nb">echo </span>1000 <span class="o">&gt;</span> serial
</code></pre></div></div>

<p>Then download the template for <code class="highlighter-rouge">/root/ca/openssl.cnf</code> from <a href="https://gist.github.com/memogarcia/2ba4b4fee8a588a7448297bc8cc4e0d9">this gist</a> and edit it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /root/ca/openssl.cnf
</code></pre></div></div>

<p>Create the root key <code class="highlighter-rouge">ca.key.pem</code> and make sure to keep it secure.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl genrsa <span class="nt">-aes256</span> <span class="nt">-out</span> private/ca.key.pem 4096
chmod 400 private/ca.key.pem
</code></pre></div></div>

<p>Create a root certificate <code class="highlighter-rouge">ca.cert.pem</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl req <span class="nt">-config</span> openssl.cnf <span class="se">\</span>
    <span class="nt">-key</span> private/ca.key.pem <span class="se">\</span>
    <span class="nt">-new</span> <span class="nt">-x509</span> <span class="nt">-days</span> 10957 <span class="nt">-sha256</span> <span class="nt">-extensions</span> v3_ca <span class="se">\</span>
    <span class="nt">-out</span> certs/ca.cert.pem
chmod 444 certs/ca.cert.pem
</code></pre></div></div>

<p>Verify the root certificate.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl x509 <span class="nt">-noout</span> <span class="nt">-text</span> <span class="nt">-in</span> certs/ca.cert.pem
</code></pre></div></div>

<h2 id="intermediate-ca">Intermediate CA</h2>

<p>It’s best practice to use intermediate CA’s instead of root CA’s to sign certificates, this practice allows a root CA to revoke a compromised intermediate CA and create a new one if necessary.</p>

<p>Prepare the environment.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /root/ca/intermediate <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /root/ca/intermediate
mkdir certs crl csr newcerts private
chmod 700 private
touch index.txt
<span class="nb">echo </span>1000 <span class="o">&gt;</span> serial
<span class="nb">echo </span>1000 <span class="o">&gt;</span> /root/ca/intermediate/crlnumber
</code></pre></div></div>

<p>Then download the template for <code class="highlighter-rouge">/root/ca/intermediate/openssl.cnf</code> from <a href="https://gist.github.com/memogarcia/4c82f92bb4daf7ebc22517df24ce7a61">this gist</a> and edit it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /root/ca/intermediate/openssl.cnf
</code></pre></div></div>

<p>Create the intermediate key <code class="highlighter-rouge">intermediate.key.pem</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /root/ca
openssl genrsa <span class="nt">-aes256</span> <span class="se">\</span>
    <span class="nt">-out</span> intermediate/private/intermediate.key.pem 4096
chmod 400 intermediate/private/intermediate.key.pem
</code></pre></div></div>

<p>With the intermediate key create an intermediate certificate request <code class="highlighter-rouge">intermediate.csr.pem</code> for the root certificate to sign. <strong>Make sure that Common Name is different from your root CA</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl req <span class="nt">-config</span> intermediate/openssl.cnf <span class="nt">-new</span> <span class="nt">-sha256</span> <span class="se">\</span>
    <span class="nt">-key</span> intermediate/private/intermediate.key.pem <span class="se">\</span>
    <span class="nt">-out</span> intermediate/csr/intermediate.csr.pem
</code></pre></div></div>

<p>The root CA will sign this certificate using <code class="highlighter-rouge">v3_intermediate_ca</code> extension. <strong>Make sure is valid for less time than the root CA</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl ca <span class="nt">-config</span> openssl.cnf <span class="nt">-extensions</span> v3_intermediate_ca <span class="se">\</span>
    <span class="nt">-days</span> 3650 <span class="nt">-notext</span> <span class="nt">-md</span> sha256 <span class="se">\</span>
    <span class="nt">-in</span> intermediate/csr/intermediate.csr.pem <span class="se">\</span>
    <span class="nt">-out</span> intermediate/certs/intermediate.cert.pem
chmod 444 intermediate/certs/intermediate.cert.pem
</code></pre></div></div>

<p><code class="highlighter-rouge">index.txt</code> is the database file. <strong>Do NOT delete this file</strong></p>

<p>Veify the intermediate certificate.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl x509 <span class="nt">-noout</span> <span class="nt">-text</span> <span class="se">\</span>
    <span class="nt">-in</span> intermediate/certs/intermediate.cert.pem
</code></pre></div></div>

<p>Verify the intermediate CA against the root CA, the output should be <code class="highlighter-rouge">OK</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl verify <span class="nt">-CAfile</span> certs/ca.cert.pem <span class="se">\</span>
    intermediate/certs/intermediate.cert.pem
</code></pre></div></div>

<p>After the verification is <code class="highlighter-rouge">OK</code>, chain the root CA and intermediate CA into a chain CA. <strong>This is only necessary if the root certificate is not installed on the client machines</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>intermediate/certs/intermediate.cert.pem <span class="se">\</span>
    certs/ca.cert.pem <span class="o">&gt;</span> intermediate/certs/ca-chain.cert.pem
chmod 444 intermediate/certs/ca-chain.cert.pem
</code></pre></div></div>

<h2 id="sign-client-certificates">Sign client certificates</h2>

<p>The intermediate certificate will be used to sign client certificates. <strong>Skip this step if you have a CSR already.</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /root/ca
openssl genrsa <span class="nt">-aes256</span> <span class="se">\</span>
    <span class="nt">-out</span> intermediate/private/www.example.com.key.pem 2048
chmod 400 intermediate/private/www.example.com.key.pem
</code></pre></div></div>

<p>Using 2048 bits for encryption on the client certificates is faster for TLS handshakes and lighter on the CPU but is less secure than using 4096 bits. Use it at discretion.</p>

<p>Using the private key <code class="highlighter-rouge">intermediate/private/www.example.com.key.pem</code>, create a CSR file. <strong>Skip this step if you have a CSR already.</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl req <span class="nt">-config</span> intermediate/openssl.cnf <span class="se">\</span>
    <span class="nt">-key</span> intermediate/private/www.example.com.key.pem <span class="se">\</span>
    <span class="nt">-new</span> <span class="nt">-sha256</span> <span class="nt">-out</span> intermediate/csr/www.example.com.csr.pem
</code></pre></div></div>

<h4 id="signing-client-certificates">Signing client certificates</h4>

<p>To create a certificate, use the intermediate CA to sign the CSR.</p>

<p>If the certificate is going to use for:</p>

<ol>
  <li>servers, use <code class="highlighter-rouge">server_cert</code> extension.</li>
  <li>authentication, use <code class="highlighter-rouge">usr_cert</code> extension.</li>
</ol>

<p>Usually, client certificates are valid for less time than the CA’s.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /root/ca
openssl ca <span class="nt">-config</span> intermediate/openssl.cnf <span class="se">\</span>
    <span class="nt">-extensions</span> server_cert <span class="nt">-days</span> 375 <span class="nt">-notext</span> <span class="nt">-md</span> sha256 <span class="se">\</span>
    <span class="nt">-in</span> intermediate/csr/www.example.com.csr.pem <span class="se">\</span>
    <span class="nt">-out</span> intermediate/certs/www.example.com.cert.pem
chmod 444 intermediate/certs/www.example.com.cert.pem
</code></pre></div></div>

<h4 id="verification">Verification</h4>

<p>Verify that <code class="highlighter-rouge">intermediate/index.txt</code> contains a <code class="highlighter-rouge">CN</code> for your domain.</p>

<p>Verify the certificate.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl x509 <span class="nt">-noout</span> <span class="nt">-text</span> <span class="se">\</span>
    <span class="nt">-in</span> intermediate/certs/www.example.com.cert.pem
</code></pre></div></div>

<p>Verify the CA certificate chain. the output should be <code class="highlighter-rouge">OK</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl verify <span class="nt">-CAfile</span> intermediate/certs/ca-chain.cert.pem <span class="se">\</span>
    intermediate/certs/www.example.com.cert.pem
</code></pre></div></div>

<h4 id="distribute">Distribute</h4>

<p>Distribute and/or deploy the following files:</p>

<ul>
  <li><code class="highlighter-rouge">ca-chain.cert.pem</code></li>
  <li><code class="highlighter-rouge">www.example.com.key.pem</code>  <strong>Only if you are signing the CSR</strong></li>
  <li><code class="highlighter-rouge">www.example.com.cert.pem</code></li>
</ul>

<h2 id="next-steps">Next steps</h2>

<ol>
  <li>Sign certificates</li>
  <li>Cash in</li>
  <li>Sell out</li>
  <li>Bro down</li>
</ol>

<h2 id="references">References</h2>

<p><a href="https://jamielinux.com/docs/openssl-certificate-authority/index.html">OpenSSL Certificate Authority</a></p>

  </div>

  

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

<a href="mailto:root@memogarcia.mx">root@memogarcia.mx</a> | <a href="http://localhost:4000/feed.xml">RSS</a>

    </p>

  </div>

</footer>


  </body>

</html>
